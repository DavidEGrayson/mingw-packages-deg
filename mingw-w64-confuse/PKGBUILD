# Maintainer: David Grayson <davidegrayson@gmail.com>

_realname=confuse
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2.7
pkgrel=1
pkgdesc='Library for parsing configuration files (mingw-w64)'
arch=('any')
url="https://www.intra2net.com/en/developer/libftdi/"
license=('custom')
makedepends=(
  "${MINGW_PACKAGE_PREFIX}-gcc"
  "${MINGW_PACKAGE_PREFIX}-gettext"
)
depends=()  # TODO: run-time dependencies for gettext (libintl.dll)?
options=('staticlibs' 'strip')
source=(
  "http://savannah.nongnu.org/download/confuse/confuse-${pkgver}.tar.gz"
)

sha256sums=('e32574fd837e950778dac7ade40787dd2259ef8e28acd6ede6847ca895c88778')

prepare() {
  cd "${srcdir}/${_realname}-${pkgver}"

  {
    echo <<EOF
This project uses the ISC license, and you can see one instance of that license
in confuse.h.  However, there are other licenses spread throughout the source
code with varying copyright messages.  In an attempt to obey each license, we
generated this file with grep.

------
EOF
    grep -hir --after-context=100 Copyright src
  } > "${srcdir}/LICENSE"
}

build() {
  mkdir -p "${srcdir}/build-${MINGW_CHOST}"
  cd "${srcdir}/build-${MINGW_CHOST}"
  MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
  "../${_realname}-${pkgver}/configure" \
    --prefix="${MINGW_PREFIX}" \
    --build="${MINGW_CHOST}" \
    --host="${MINGW_CHOST}" \
    --enable-static \
    --enable-shared \
    --disable-examples \

  # TODO: man pages

  make
}

check() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  # TODO: make check
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  make DESTDIR="${pkgdir}" install

  cd "${srcdir}"
  install -Dm644 LICENSE "${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/LICENSE"
}
